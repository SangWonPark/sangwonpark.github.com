---
title: "네트워크: 스패닝 트리 프로토콜(STP)"
date: 2022-02-20T16:03:00
last_modified_at: 2022-02-20T16:03:00
header:
  overlay_color: "#5F9EA0"
layout: single
classes: wide
categories:
  - network
tags:
  - 알고리즘
  - 스패닝트리
  - 스위치
  - 브리지

toc: true
toc_sticky: true
toc_label: "목차"
---

_**루핑**을 막아주는 스패닝트리 알고리즘에 대해 알아보겠습니다._

## 스패닝 트리 프로토콜

스패닝 트리 프로토콜(STP: spanning tree protocol)은 ARP등의 요청에 의한 **루핑**을 막아주기 위한 프로토콜입니다.

### 루핑?

루핑은 통신 출발지에서 도착지까지 도달할 수 있는 경로가 두 개 이상 존재할 경우 통신이 네트워크 상에서 무한히 맴도는 현상으로 
네트워크 상의 통신 속도가 저하되거나 심하면 시스템이 다운될 수 있습니다.

### 루핑을 어떻게 막을까?

루핑은 출발지에서 도착지까지 도달할 수 있는 경로가 두 개 이상 존재할 경우 발생하므로 출발지에서 도착지까지의 경로가 하나만 존재하도록 만들면 됩니다.

## 스패닝 트리 알고리즘

이제부터 출발지에서 목적지까지의 경로를 하나로 만들어주는 스패닝 트리 알고리즘을 적용하는 과정에 대해 알아보겠습니다.
스패닝 트리 알고리즘을 이해하기 위해서는 먼저 *브리지ID*, *Path Cost*를 이해해야합니다.

1. 브리지ID: 브리지ID는 2byte의 브리지 우선순위(Bridge Priority)와 6byte의 맥 어드레스로 구성되며, 
             하나의 네트워크(=브로드캐스트 도메인) 상에 루트 브리지등을 선출하는데 사용합니다.
2. Path Cost: 말 그대로 경로 비용으로 생각해도 됩니다. 두 스위치를 잇는 링크의 속도에 따라 결정되고, 속도가 빠를수록 Cost는 작아집니다. 
               링크 속도에 따라 IEEE에서 산정한 Path Cost도 있으니 참고하면 좋을것 같습니다.

이제 *브리지ID(BID)*, *Path Cost*로 '루트 브리지'와 스위치별 각 '루트 포트', '데지그네이티드 포트(Designated Port)'를 선출합니다. 

각 포트 선출은 나머지 포트를 모두 막아버리기 위함이며, 나머지 포트를 막음으로써 복수의 경로가 생기는 것을 막아줍니다.

### '루트 브리지'와 '루트 포트' 그리고 '데지그네이티드 포트' 선출

#### '루트 브리지 선출'

루트 브리지 선출은 '브리지ID'로 선출하고, 네트워크 상에 **가장 낮은 브리지ID**를 가진 스위치가 **'루트 브리지'**가 됩니다.

#### '루트 포트' 선출

루트 브리지가 정해지면 그 이외의 '논 루트 브리지(Non Root Bridge)'에서는 '루트 포트'를 선출합니다.

'루트 포트'는 각 스위치(논 루트 브리지)에서 루트 브리지와 가장 가까운 포트를 '루트 포트'로 선출하고, 
가장 가깝다는 것은 각 '포트'에서 '루트 브리지'까지의 'Path Cost'(=세그먼트)로 결정합니다. 

#### '데지그네이티드 포트(Designated Port)' 선출

네트워크에서 각 브리지간의 연결된 경로를 세그먼트라고 하는데 이 세그먼트당 하나의 '데지그네이티드 포트'를 갖습니다.

데지그네이티드 포트는 다음 단계를 거쳐 결정됩니다. 

1. 누가 더 작은 Root BID를 가졌는가?
2. 루트 브리지 까지의 Path Cost값이 누가 더 작은가?
3. 누구의 BID가 더 낮은가?
4. 누구의 포트 ID가 더 낮은가?

'데지그네이티드 포트'까지 모두 선정이 끝나면 나머지 포트는 '논 데지그네이티드 포트(Non Designated Port)'로 지정됩니다.

## 5가지 상태

스패닝 트리 프로토콜을 구현해 나가는 과정에서 모든 스위치/브리지의 포트들은 5가지 상태로 변합니다.

| 상태       | 데이터 전송   | 맥 어드레스 학습  | BPDU 통신 | 설명                            |
|:----------|:-----------|:--------------|:---------|:------------------------------:|
| Disabled  | 불가능      | 불가능          | 불가능     | 포트가 고장나서 사용할 수 없거나 포트가 작업자에 의해 Shut Down된 상태 |
|----
| Blocking  | 불가능      | 불가능          | 가능      | 스위치를 처음 켜거나 작업자가 포트를 살렸을 때, 데이터 전송 없이 스위치간에 BPDU만 주고 받으며 '루트 브리지'와 각 '포트'를 선출합니다.|
|----
| Listening | 불가능      | 불가능          | 가능      | '루트 브리지'와 각 '포트'를 선출되면 리스닝 상태로 넘어가며, 새로운 스위치가 접속하거나 스위치/브리지의 구성이 바뀌면 다시 블로킹 상태로 넘어갑니다.|
|----
| Learning  | 불가능      | 가능           | 가능      | 리스닝 상태의 포트가 **포워딩 딜레이** 시간(Default 15초)을 유지하면 러닝 상태로 넘어옵니다.|
|----
| Forwarding| 가능       | 가능           | 가능      | 스위치 포트가 러닝 상태에서 **포워딩 딜레이** 시간을 유지하면 포워딩 상태로 넘어갑니다.|

## 스패닝 트리 구조 조정

스위치/브리지들이 루트 브리지로부터 일정 시간(Max Age)동안 헬로 패킷을 받지 못하면 루트 브리지가 죽었다 생각하고 새로운 스패닝 트리를 만들기 시작합니다.

* Hello Time: 루트 브리지가 자신에게 연결된 브지리에게 헬로 BPDU를 헬로타임마다 한번 씩 보내게 됩니다. 기본값은 2초 입니다.
* Max Age: 브리지에서 Max Age 안에 헬로 패킷 수신 여부를 보고, 루트 브리지가 살아있는지 죽었는지 판단하게 됩니다.
* Forwarding Delay: 브리지가 포트가 블로킹 상태에서 포워딩 상태로 넘어가기 까지 걸리는 시간입니다.(블로킹에서 포워딩으로 넘어가는 시간은 포워딩 딜레이의 최소 두배입니다.)

